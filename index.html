<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmes Favoritos</title>
    <script>
      // Aplica o tema (claro/escuro) imediatamente para evitar "flash" de conte√∫do sem estilo
      (function() {
        const THEME_KEY = 'theme-preference';
        const preference = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        let theme = 'light'; // Tema padr√£o
        if (preference) {
          theme = preference;
        } else if (prefersDark) {
          theme = 'dark';
        }
        
        document.documentElement.dataset.theme = theme;
      })();
    </script>
</head>
<body>
    <main>
      <div class="flexbox-header">
      <button id="theme-toggle" class="theme-toggle" title="Alternar tema claro/escuro"></button><h1 class="page-title">Filmes populares usando API TMDB</h1>
      <form class="search-form" action="#" role="search" aria-label="Pesquisar filmes">
          <label for="search" class="visually-hidden">Pesquisar filmes</label>
          <input id="search" name="q" type="search" class="search-input" placeholder="Palavra-chave" />
          <button type="submit" class="search-button">Pesquisar</button>
          <button type="button" id="show-favorites-btn" class="favorites-button">Meus Favoritos</button>
          <button type="button" class="clear-button">Limpar</button>
      </form> 
      </div>

      <!-- Container para os cart√µes de filmes -->
      <div class="flexbox-container">
        <!-- Filmes ser√£o inseridos aqui dinamicamente -->          
      </div>
    </main>
      <script>
      // Vari√°vel de estado para controlar a exibi√ß√£o de favoritos
      let showingOnlyFavorites = false;

      document.addEventListener('DOMContentLoaded', function() {
        const container = document.querySelector('.flexbox-container');

        // --- L√≥gica do bot√£o de altern√¢ncia de tema ---
        const themeToggleButton = document.getElementById('theme-toggle');
        if (themeToggleButton) {
          const THEME_KEY = 'theme-preference';

          // Atualiza o √≠cone e o r√≥tulo do bot√£o
          function updateThemeButton(theme) {
            themeToggleButton.innerHTML = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            themeToggleButton.setAttribute('aria-label', `Alternar para tema ${theme === 'dark' ? 'claro' : 'escuro'}`);
          }

          // Define o estado inicial do bot√£o
          const initialTheme = document.documentElement.dataset.theme || 'light';
          updateThemeButton(initialTheme);

          themeToggleButton.addEventListener('click', () => {
            const currentTheme = document.documentElement.dataset.theme || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Aplica o novo tema
            document.documentElement.dataset.theme = newTheme;
            localStorage.setItem(THEME_KEY, newTheme);
            
            // Atualiza a UI do bot√£o
            updateThemeButton(newTheme);
          });
        }

        if (!container) return;

        // Retorna a lista de filmes favoritos do localStorage
        function getFavoriteMovies() {
          return JSON.parse(localStorage.getItem('movies') || '[]');
        }

        function isFavorite(movie) {
          const favs = getFavoriteMovies();
          
          // Isso permite que filmes sem ID (adicionados manualmente) sejam verificados pelo t√≠tulo
          if (movie.id) {
            return favs.some(m => m.id === movie.id);
          }
          return favs.some(m => (m.title || '').toLowerCase() === (movie.title || '').toLowerCase());
        }

        function normalizeForStorage(movie) {
          // Garante que o URL completo do p√¥ster seja salvo para filmes da TMDB.
          // Filmes adicionados manualmente j√° devem ter um URL completo em `movie.poster`.
          let finalPosterUrl = movie.poster || null;
          if (!finalPosterUrl && movie.poster_path) {
            finalPosterUrl = 'https://image.tmdb.org/t/p/w500' + movie.poster_path;
          }
          return {
            id: movie.id,
            title: movie.title,
            poster: finalPosterUrl
          };
        }

        function addFavorite(movie) {
          const favs = getFavoriteMovies();
          if (isFavorite(movie)) return;
          favs.push(normalizeForStorage(movie));
          localStorage.setItem('movies', JSON.stringify(favs));
        }

        function removeFavorite(movie) {
          let favs = getFavoriteMovies();
          
          //Remove o ID primeiro (filmes TMDB), depois pelo t√≠tulo (adicionados manualmente)
          if (movie.id) {
            favs = favs.filter(m => m.id !== movie.id);
          } else {
            favs = favs.filter(m => (m.title || '').toLowerCase() !== (movie.title || '').toLowerCase());
          }
          localStorage.setItem('movies', JSON.stringify(favs));
        }

        // Renderizar um cart√£o de filme
        function renderMovie(movie, opts = { index: 0 }) {
          const item = document.createElement('div');
          // Garantir que o cart√£o sempre tenha as regras de .flexbox-item
          const baseClass = 'flexbox-item';
          item.className = baseClass + (opts.className ? ' ' + opts.className : '');
          item.tabIndex = 0; // torna naveg√°vel por teclado
          item.setAttribute('role', 'button');

          const h2 = document.createElement('h2');
          h2.textContent = movie.title || 'Untitled';

          // Adiciona um delay para a anima√ß√£o de entrada, criando um efeito "stagger"
          item.style.animationDelay = `${opts.index * 50}ms`;

          const img = document.createElement('img');
          let posterSrc = '';
          if (movie.poster) posterSrc = movie.poster;
          else if (movie.poster_path) posterSrc = 'https://image.tmdb.org/t/p/w500' + movie.poster_path;

          if (posterSrc) {
            img.src = posterSrc;
            img.alt = (movie.title || '') + ' Poster';
            img.width = 200;
            img.loading = 'lazy'; // Melhora a performance de carregamento
          }
          const favBtn = document.createElement('button');
          favBtn.type = 'button';
          favBtn.className = 'fav-button';
          const favorited = isFavorite(movie);
          if (favorited) favBtn.classList.add('favorited');
          favBtn.setAttribute('aria-pressed', favorited ? 'true' : 'false');
          favBtn.innerHTML = favorited
            ? '<img src="img/Heart.svg" alt="" width="20"> Favorito'
            : '<img src="img/Vector.svg" alt="" width="20"> Favoritar';

          favBtn.addEventListener('click', (ev) => {
            ev.stopPropagation(); // n√£o propaga para o card
            if (isFavorite(movie)) {
              removeFavorite(movie);
              favBtn.classList.remove('favorited');
              favBtn.setAttribute('aria-pressed', 'false');
              favBtn.innerHTML = '<img src="img/Vector.svg" alt="" width="20"> Favoritar';
              showToast('Removido dos favoritos', 'info');
            } else {
              addFavorite(movie);
              favBtn.classList.add('favorited');
              favBtn.setAttribute('aria-pressed', 'true');
              favBtn.innerHTML = '<img src="img/Heart.svg" alt="" width="20"> Favorito';
              showToast('Adicionado aos favoritos', 'success');
            }
          });

          // abrir detalhes ao clicar no cart√£o (exceto no bot√£o de favorito)
          item.addEventListener('click', (e) => {
            if (e.target.closest('.fav-button')) return;
            showMovieDetails(movie);
          });

          // permitir abertura via teclado (Enter / Space)
          item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              showMovieDetails(movie);
            }
          });

          item.appendChild(h2);
          if (posterSrc) {
            item.appendChild(img);
          }
          item.appendChild(favBtn);

          container.appendChild(item);
        }

        // Mostrar detalhes do filme em um modal
        let openerElement; // Armazena o elemento que abriu o modal
        function showMovieDetails(movie) {
          const modal = document.getElementById('movie-modal');
          openerElement = document.activeElement; // Salva o elemento focado
          const body = modal.querySelector('.modal-body');
          body.innerHTML = '';

          const title = document.createElement('h2');
          title.textContent = movie.title || 'Untitled';
          // Adiciona um ID ao t√≠tulo para ser referenciado pelo aria-labelledby do modal
          title.id = 'modal-title';

          const img = document.createElement('img');
          let posterSrc = movie.poster || (movie.poster_path ? 'https://image.tmdb.org/t/p/w500' + movie.poster_path : '');
          if (posterSrc) {
            img.src = posterSrc;
            img.alt = (movie.title || '') + ' Poster';
            img.style.maxWidth = '240px';
            img.style.display = 'block';
            img.style.marginBottom = '12px';
            body.appendChild(img);
          }

          body.appendChild(title);

          // Se houver mais detalhes, mostr√°-los
          if (movie.overview) {
            const ov = document.createElement('p');
            ov.textContent = movie.overview;
            body.appendChild(ov);
          }

          if (movie.release_date) {
            const rel = document.createElement('p');
            rel.textContent = 'Data de lan√ßamento: ' + movie.release_date;
            body.appendChild(rel);
          }

          if (movie.vote_average) {
            const vote = document.createElement('p');
            vote.textContent = 'Avalia√ß√£o: ' + movie.vote_average;
            body.appendChild(vote);
          }

          // Menssagem fallback se nenhum detalhe adicional estiver dispon√≠vel
          if (!movie.overview && !movie.release_date && !movie.vote_average) {
            const info = document.createElement('p');
            info.textContent = 'Detalhes adicionais n√£o dispon√≠veis para este filme.';
            body.appendChild(info);
          }

          // show modal
          modal.classList.add('open');
          modal.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';

          // Move o foco para o bot√£o de fechar dentro do modal
          modal.querySelector('.modal-close').focus();
        }

        function hideModal() {
          const modal = document.getElementById('movie-modal');
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
          // Devolve o foco para o elemento que abriu o modal
          if (openerElement) openerElement.focus();
        }

        // --- Notifica√ß√µes do cliente ---
        function showToast(message, type = 'info', timeout = 2500) {
          let container = document.getElementById('toast-container');
          if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.setAttribute('aria-live', 'assertive');
            container.setAttribute('role', 'alert');
            document.body.appendChild(container);
          }

          const t = document.createElement('div');
          t.className = 'toast ' + (type === 'success' ? 'toast-success' : 'toast-info');
          t.textContent = message;
          container.appendChild(t);

          requestAnimationFrame(() => t.classList.add('show'));

          setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 300);
          }, timeout);
        }

        //  Eventos do modal de detalhes do filme  (fechar, clique fora, Escape)
        (function wireModalEvents() {
          const modal = document.getElementById('movie-modal');
          if (!modal) return;
          const closeBtn = modal.querySelector('.modal-close');

          closeBtn.addEventListener('click', hideModal);

          // click fora do conte√∫do
          modal.addEventListener('click', (e) => {
            if (e.target === modal) hideModal();
          });

          // Fechar com Escape
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') hideModal();
          });

          // Trava o foco dentro do modal
          modal.addEventListener('keydown', (e) => {
            if (e.key !== 'Tab' || !modal.classList.contains('open')) return;

            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (e.shiftKey) { // Shift + Tab
              if (document.activeElement === firstElement) {
                lastElement.focus();
                e.preventDefault();
              }
            } else { // Tab
              if (document.activeElement === lastElement) {
                firstElement.focus();
                e.preventDefault();
              }
            }
          });
        })();

        // Fun√ß√£o auxiliar para redefinir a visualiza√ß√£o de "somente favoritos"
        function resetFavoritesView() {
          if (showingOnlyFavorites) {
            showingOnlyFavorites = false;
            const btn = document.getElementById('show-favorites-btn');
            if (btn) {
              btn.classList.remove('active');
              btn.textContent = 'Meus Favoritos';
            }
          }
        }
        
       // Buscar filmes populares via secure backend proxy
       async function getPopularMovies() {
          try {
            console.log('[client] Fetching /api/popular-movies');
            // Chamada ao backend proxy seguro
            // Este backend adiciona a chave da API TMDB de forma segura
            const res = await fetch('/api/popular-movies?language=pt-BR&page=1');
            console.log('[client] response status', res.status);
            if (!res.ok) throw new Error('Falha ao buscar filmes populares: ' + res.status);
            const data = await res.json();
            console.log('[client] fetched popular movies count', (data.results || []).length);
            return data.results || [];
          } catch (err) {
            console.error('Erro ao buscar filmes populares:', err);
            // Mostrar mensagem de erro ao usu√°rio
            const header = document.querySelector('.flexbox-header');
            if (header) {
              let el = document.getElementById('popular-error');
              if (!el) {
                el = document.createElement('p');
                el.id = 'popular-error';
                el.style.color = 'red';
                el.style.marginTop = '8px';
                header.appendChild(el);
              }
              el.textContent = 'N√£o foi poss√≠vel carregar filmes populares. Verifique o servidor proxy.';
            }
            return [];
          }
        }

        // carregar e renderizar filmes populares
        getPopularMovies().then(movies => {
          if (movies.length > 0) {
            showMovies(movies, 'Filmes populares');
          }
        });

        // ----- Busca de filmes via backend proxy `/api/search-movies` -----
        const searchForm = document.querySelector('.search-form');
        const searchInput = document.getElementById('search');
        const header = document.querySelector('.flexbox-header');

        // √Årea para mostrar mensagens sobre resultados
        let resultsInfo = document.getElementById('results-info');
        if (!resultsInfo && header) {
          resultsInfo = document.createElement('p');
          resultsInfo.id = 'results-info';
          resultsInfo.style.marginTop = '8px';
          resultsInfo.setAttribute('aria-live', 'polite'); // Anuncia mudan√ßas para leitores de tela
          header.appendChild(resultsInfo);
        }

        async function searchMovies(query) {
          try {
            console.log('[client] Searching movies for', query);
            const res = await fetch('/api/search-movies?query=' + encodeURIComponent(query) + '&language=pt-BR&page=1');
            if (!res.ok) throw new Error('Falha ao buscar filmes: ' + res.status);
            const data = await res.json();
            return data.results || [];
          } catch (err) {
            console.error('Erro na busca de filmes:', err);
            if (resultsInfo) resultsInfo.textContent = 'Erro ao buscar filmes. Verifique o servidor proxy.';
            return [];
          }
        }

        // Limpa o container e renderiza um conjunto de filmes
        function showMovies(movies, infoMessage) {
          container.innerHTML = '';
          if (movies.length === 0) {
            if (resultsInfo) resultsInfo.textContent = infoMessage || 'Nenhum filme encontrado.';
            return;
          }
          if (resultsInfo) resultsInfo.textContent = infoMessage || ('Exibindo ' + movies.length + ' resultados.');
          movies.forEach((m, index) => renderMovie(m, { className: 'movie', index }));
        }

        if (searchForm) {
          searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetFavoritesView();
            const q = (searchInput.value || '').trim();
            if (!q) {
              // Se campo vazio, recarregar filmes populares
              resultsInfo.textContent = 'Campo vazio ‚Äî carregando filmes populares...';
              const popular = await getPopularMovies();
              showMovies(popular, 'Filmes populares');
              return;
            }

            resultsInfo.textContent = 'Buscando...';
            const movies = await searchMovies(q);
            if (movies.length === 0) {
              showMovies([], 'Sem resultados para "' + q + '".');
            } else {
              showMovies(movies, 'Exibindo ' + movies.length + ' resultados para "' + q + '".');
            }
          });

          // Bot√£o limpar: limpa campo e recarrega filmes populares
          const clearBtn = document.querySelector('.clear-button');
          if (clearBtn) {
            clearBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              resetFavoritesView();
              searchInput.value = '';
              if (resultsInfo) resultsInfo.textContent = 'Campo limpo ‚Äî carregando filmes populares...';
              const popular = await getPopularMovies();
              showMovies(popular, 'Filmes populares');
              searchInput.focus();
            });
          }          
          // ----- Fim da busca de filmes -----

          // ----- L√≥gica para mostrar/ocultar favoritos -----
          const showFavoritesBtn = document.getElementById('show-favorites-btn');
          if (showFavoritesBtn) {
            showFavoritesBtn.addEventListener('click', () => {
              showingOnlyFavorites = !showingOnlyFavorites;

              if (showingOnlyFavorites) {
                const favs = getFavoriteMovies();
                const message = favs.length > 0 ? `Exibindo ${favs.length} filme(s) favorito(s)` : 'Voc√™ ainda n√£o tem filmes favoritos.';
                showMovies(favs, message);
                showFavoritesBtn.textContent = 'Mostrar Todos';
                showFavoritesBtn.classList.add('active');
                searchInput.value = ''; // Limpa a busca
              } else {
                showFavoritesBtn.textContent = 'Meus Favoritos';
                showFavoritesBtn.classList.remove('active');
                if (resultsInfo) resultsInfo.textContent = 'Carregando filmes populares...';
                getPopularMovies().then(movies => {
                  showMovies(movies, 'Filmes populares');
                });
              }
            });
          }
          // Favoritos s√£o gerenciados pelas fun√ß√µes auxiliares definidas acima (addFavorite/removeFavorite/getFavoriteMovies)
        }
      });
      </script>

      <!-- Modal para detalhes do filme -->
      <div id="movie-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content" role="document">
          <button class="modal-close" aria-label="Fechar">&times;</button>
          <div class="modal-body"></div>
        </div>
      </div>

</body>
</html>